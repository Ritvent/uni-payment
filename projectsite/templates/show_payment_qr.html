{% extends "base.html" %}

{% block title %}Payment QR - UniPay{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="initQRCode()" onerror="loadQRCodeFallback()"></script>
    <style>
        /* Success overlay styles */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }
        
        .success-overlay.show {
            display: flex;
        }
        
        .success-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: scaleIn 0.4s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: pulse 1s ease-in-out infinite;
        }
        
        .success-icon svg {
            width: 50px;
            height: 50px;
            color: white;
        }
        
        .checkmark {
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: drawCheck 0.6s ease-out 0.3s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes drawCheck {
            to { stroke-dashoffset: 0; }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #10b981;
            animation: confettiFall 3s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
    <script>
        function loadQRCodeFallback() {
            var script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
            script.onload = initQRCode;
            document.head.appendChild(script);
        }
        
        function initQRCode() {
            if (typeof QRCode !== 'undefined') {
                setTimeout(function() {
                    try {
                        var qrElement = document.getElementById("qrcode");
                        if (qrElement && qrElement.innerHTML.trim() === '') {
                            new QRCode(qrElement, {
                                text: "{{ qr_data|escapejs }}",
                                width: 200,
                                height: 200,
                                colorDark : "#000000",
                                colorLight : "#ffffff",
                                correctLevel : QRCode.CorrectLevel.H
                            });
                        }
                    } catch (error) {
                        console.error('Error generating QR code:', error);
                        var qrElement = document.getElementById("qrcode");
                        if (qrElement) {
                            qrElement.innerHTML = '<p class="text-danger">Error generating QR code. Please try again.</p>';
                        }
                    }
                }, 50);
            }
        }
    </script>
{% endblock %}

{% block content %}
<!-- Success Overlay -->
<div id="success-overlay" class="success-overlay">
    <div class="success-modal">
        <div class="success-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path class="checkmark" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
        <p class="text-gray-600 mb-2">Your payment for <strong>{{ payment_request.fee_type.name }}</strong> has been confirmed.</p>
        <p class="text-2xl font-bold text-emerald-600 mb-4">₱{{ payment_request.amount|floatformat:2 }}</p>
        <p class="text-sm text-gray-500 mb-4">Redirecting to your receipt...</p>
        <div class="flex gap-3 justify-center">
            <a href="{% url 'student_dashboard' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                Back to Dashboard
            </a>
            <a id="view-receipt-btn" href="#" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                View Receipt
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-7">
        <div class="card text-center shadow-lg border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0"><i class="fas fa-qrcode me-2"></i>Your Payment QR Code</h2>
                    {% if payment_request.organization.get_logo_path %}
                        <img src="{{ payment_request.organization.get_logo_path }}" alt="{{ payment_request.organization.name }} Logo" 
                             class="img-fluid" style="max-height: 50px; max-width: 150px; object-fit: contain; background: white; padding: 5px; border-radius: 5px;">
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                
                <div id="status-alert">
                    {% if payment_request.status == 'PENDING' %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i><strong>Status: PENDING.</strong> Present this QR code at the <b>{{ payment_request.organization.code }}</b> booth.
                        </div>
                    {% elif payment_request.status == 'EXPIRED' %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-ban me-2"></i><strong>Status: EXPIRED.</strong> This request has timed out. Please generate a new QR code.
                        </div>
                    {% elif payment_request.status == 'PAID' %}
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i><strong>Status: PAID.</strong> Payment completed successfully!
                        </div>
                    {% endif %}
                </div>
                
                <h4 class="mt-3">Payment Request</h4>
                <p class="text-muted">For: <b>{{ payment_request.fee_type.name }}</b> (₱{{ payment_request.amount|floatformat:2 }})</p>
                <hr>
                
                <div id="qrcode" class="my-4 mx-auto border border-3 p-2 rounded" style="width:220px; height:220px; border-color: var(--green-primary) !important;">
                </div>
                
                <p class="text-muted small mb-1">
                    Request Valid Until: <span id="expires-at" class="fw-bold">{{ payment_request.expires_at|date:"F j, Y, g:i a" }}</span>
                </p>
                <div id="time-remaining" class="text-danger fw-bold fs-5"></div>
                
                <a href="{% url 'student_dashboard' %}" class="btn btn-outline-primary mt-3"><i class="fas fa-arrow-left me-2"></i>Back to Dashboard</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    if (typeof QRCode !== 'undefined') {
        initQRCode();
    } else {
        window.addEventListener('load', function() {
            if (typeof QRCode !== 'undefined') {
                initQRCode();
            } else {
                document.getElementById('qrcode').innerHTML = '<p class="text-danger">Error loading QR code library. Please refresh the page.</p>';
            }
        });
    }

    // Play success sound
    function playSuccessSound() {
        try {
            // Create audio context for success sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // First beep
            const oscillator1 = audioContext.createOscillator();
            const gainNode1 = audioContext.createGain();
            oscillator1.connect(gainNode1);
            gainNode1.connect(audioContext.destination);
            oscillator1.frequency.value = 523.25; // C5
            oscillator1.type = 'sine';
            gainNode1.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            oscillator1.start(audioContext.currentTime);
            oscillator1.stop(audioContext.currentTime + 0.2);
            
            // Second beep (higher pitch)
            setTimeout(() => {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                oscillator2.frequency.value = 659.25; // E5
                oscillator2.type = 'sine';
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator2.start(audioContext.currentTime);
                oscillator2.stop(audioContext.currentTime + 0.3);
            }, 150);
            
            // Third beep (highest pitch)
            setTimeout(() => {
                const oscillator3 = audioContext.createOscillator();
                const gainNode3 = audioContext.createGain();
                oscillator3.connect(gainNode3);
                gainNode3.connect(audioContext.destination);
                oscillator3.frequency.value = 783.99; // G5
                oscillator3.type = 'sine';
                gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                oscillator3.start(audioContext.currentTime);
                oscillator3.stop(audioContext.currentTime + 0.4);
            }, 300);
        } catch (e) {
            console.log('Audio not supported');
        }
    }

    // Create confetti effect
    function createConfetti() {
        const colors = ['#10b981', '#059669', '#34d399', '#6ee7b7', '#fbbf24', '#f59e0b'];
        const overlay = document.getElementById('success-overlay');
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                overlay.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => confetti.remove(), 4000);
            }, i * 30);
        }
    }

    // Show success overlay
    function showSuccessOverlay(paymentId) {
        console.log('showSuccessOverlay called with paymentId:', paymentId);
        const overlay = document.getElementById('success-overlay');
        const viewReceiptBtn = document.getElementById('view-receipt-btn');
        
        // Set the receipt URL
        if (paymentId) {
            viewReceiptBtn.href = "/staff/payments/" + paymentId + "/";
        }
        
        // Show overlay with animation
        overlay.classList.add('show');
        console.log('Overlay should now be visible');
        
        // Play sound and create confetti
        playSuccessSound();
        createConfetti();
        
        // Auto-redirect to receipt after 5 seconds
        if (paymentId) {
            setTimeout(() => {
                window.location.href = viewReceiptBtn.href;
            }, 5000);
        }
    }

    function checkStatus() {
        const url = "{% url 'api_request_status' payment_request.request_id %}";
        console.log('Checking status at:', url);
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Status response:', data);
                const statusAlert = document.getElementById('status-alert');
                const timeRemainingDiv = document.getElementById('time-remaining');
                
                if (data.status === 'PAID') {
                    console.log('Payment is PAID! payment_id:', data.payment_id);
                    clearInterval(pollInterval);
                    statusAlert.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i><strong>Status: PAID.</strong> Payment completed successfully!</div>';
                    timeRemainingDiv.textContent = 'Transaction Complete.';
                    
                    // Show success overlay with payment ID
                    showSuccessOverlay(data.payment_id);
                } else if (data.status === 'EXPIRED' || data.is_expired) {
                    clearInterval(pollInterval);
                    statusAlert.innerHTML = '<div class="alert alert-danger"><i class="fas fa-ban me-2"></i><strong>Status: EXPIRED.</strong> This request has timed out. Please generate a new QR code.</div>';
                    timeRemainingDiv.textContent = 'EXPIRED';
                } else if (data.status === 'PENDING') {
                    timeRemainingDiv.textContent = 'Expires In: ' + data.time_remaining;
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                // Don't stop polling on transient errors
            });
    }

    // Poll every 3 seconds for faster response
    const pollInterval = setInterval(checkStatus, 3000);
    checkStatus(); 

    window.onbeforeunload = function() {
        clearInterval(pollInterval);
    };
</script>
{% endblock %}
