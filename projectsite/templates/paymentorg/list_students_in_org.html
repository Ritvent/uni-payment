{% extends 'base.html' %}
{% load static %}

{% block title %}View Students - UniPay{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                    <i data-lucide="book-open" class="w-8 h-8 text-indigo-600"></i>
                    Students in {{ user_organization.name }}
                </h1>
                <p class="text-gray-600 mt-2">View and promote eligible students</p>
            </div>
            <a href="{% url 'officer_dashboard' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Dashboard
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-6" role="alert">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Students List -->
        {% if students %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Student Name</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Student ID</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Email</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Program</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Role</th>
                                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for student in students %}
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-900">{{ student.user.get_full_name }}</div>
                                    </td>
                                    <td class="px-6 py-4 text-gray-600 font-mono text-sm">{{ student.student_id_number }}</td>
                                    <td class="px-6 py-4 text-gray-600">{{ student.user.email }}</td>
                                    <td class="px-6 py-4 text-gray-600 text-sm">{{ student.course.program_type }}</td>
                                    <td class="px-6 py-4">
                                        <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold
                                            {% if student.is_superuser %}
                                                bg-indigo-100 text-indigo-700
                                            {% elif student.is_super_officer %}
                                                bg-purple-100 text-purple-700
                                            {% elif student.is_promoted %}
                                                bg-emerald-100 text-emerald-700
                                            {% else %}
                                                bg-blue-100 text-blue-700
                                            {% endif %}">
                                            {% if student.is_superuser %}
                                                <i data-lucide="shield" class="w-3 h-3"></i> Superuser
                                            {% elif student.is_super_officer %}
                                                <i data-lucide="crown" class="w-3 h-3"></i> Super Officer
                                            {% elif student.is_promoted %}
                                                <i data-lucide="briefcase" class="w-3 h-3"></i> Officer
                                            {% else %}
                                                <i data-lucide="book-open" class="w-3 h-3"></i> Student
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center relative">
                                        <button type="button" data-dropdown-toggle class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                            </svg>
                                        </button>
                                        <div data-dropdown-menu class="hidden absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 py-1">
                                            <a href="{% url 'student_detail' student.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 border-b border-gray-100">View Details</a>
                                            {% if student.can_promote %}
                                                <a href="{% url 'promote_student_to_officer' %}?student_id={{ student.id }}" class="block px-4 py-2 text-sm text-emerald-600 hover:bg-emerald-50 border-b border-gray-100">Promote to Officer</a>
                                            {% endif %}
                                            {% if student.can_demote %}
                                                <a href="{% url 'demote_officer_to_student' %}?officer_id={{ student.user.officer_profile.id }}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 border-b border-gray-100">Demote to Student</a>
                                            {% endif %}
                                            {% if student.can_make_super_officer and not student.is_superuser %}
                                                <a href="#" onclick="setSuperOfficer(event, {{ student.id }}, '{{ student.user.username }}')" class="block px-4 py-2 text-sm text-purple-600 hover:bg-purple-50">{% if student.is_super_officer %}Revoke{% else %}Make{% endif %} Super Officer</a>
                                            {% endif %}
                                            {% if student.can_make_superuser %}
                                                <a href="#" onclick="setSuperuser(event, {{ student.id }}, '{{ student.user.username }}')" class="block px-4 py-2 text-sm text-indigo-600 hover:bg-indigo-50 border-t border-gray-100">{% if student.is_superuser %}Revoke{% else %}Make{% endif %} Superuser</a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="mt-6 flex justify-center gap-2">
                    {% if page_obj.has_previous %}
                        <a href="?page=1" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">First</a>
                        <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">Previous</a>
                    {% endif %}

                    <span class="px-3 py-2 text-sm">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">Next</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">Last</a>
                    {% endif %}
                </div>
            {% endif %}
        {% else %}
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                    <i data-lucide="book-open" class="w-8 h-8 text-gray-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Students Available</h3>
                <p class="text-gray-600 mb-6">There are no students available for promotion in your organization.</p>
                <a href="{% url 'officer_dashboard' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Back to Dashboard
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    lucide.createIcons();
    
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('[data-dropdown-toggle]');
        
        buttons.forEach(button => {
            const menu = button.nextElementSibling;
            
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                // Close all other menus
                document.querySelectorAll('[data-dropdown-menu]').forEach(m => {
                    if (m !== menu) {
                        m.classList.add('hidden');
                    }
                });
                // Toggle current menu
                menu.classList.toggle('hidden');
            });
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('[data-dropdown-menu]').forEach(menu => {
                menu.classList.add('hidden');
            });
        });
    });
    
    function setSuperOfficer(event, studentId, username) {
        event.preventDefault();
        if (confirm(`Toggle Super Officer status for ${username}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'set_super_officer' %}';
            
            const studentIdInput = document.createElement('input');
            studentIdInput.type = 'hidden';
            studentIdInput.name = 'student_id';
            studentIdInput.value = studentId;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'toggle_super_officer';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            
            form.appendChild(studentIdInput);
            form.appendChild(actionInput);
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function setSuperuser(event, studentId, username) {
        event.preventDefault();
        if (confirm(`Toggle Superuser status for ${username}? This will grant/revoke full system access.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'set_super_officer' %}';
            
            const studentIdInput = document.createElement('input');
            studentIdInput.type = 'hidden';
            studentIdInput.name = 'student_id';
            studentIdInput.value = studentId;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'toggle_superuser';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            
            form.appendChild(studentIdInput);
            form.appendChild(actionInput);
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
